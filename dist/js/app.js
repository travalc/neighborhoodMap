var map,portland,infoWindow,visibleLocations,bounds,listView=document.getElementById("listView"),view={initMap:function(){portland=new google.maps.LatLng(45.522946,-122.673517),map=new google.maps.Map(document.getElementById("map"),{center:portland,zoom:16}),bounds=new google.maps.LatLngBounds,model.initialize()},openList:function(){listView.style.height="40%"},closeList:function(){listView.style.height="0"}},model={locations:[],initialize:function(){function i(){return Math.floor(1e12*Math.random()).toString()}var e="https://api.yelp.com/v2/search",o={oauth_consumer_key:"LyiqmxYUbuLB9p1a_lx8gA",oauth_token:"GZpLwoqEwunNaFT7HwNoRsCiXE3mxMXt",oauth_nonce:i(),oauth_timestamp:Math.floor(Date.now()/1e3),oauth_signature_method:"HMAC-SHA1",oauth_version:"1.0",callback:"cb",term:"restaurant",location:"Portland Chinatown",cll:"45.5231, -122.6765",radius_filter:600,sort:2},n=oauthSignature.generate("GET",e,o,"rjAxpO7SFR9hyQUtOPvEqOgdDa0","FUgWz5YLb7CyIhOOpUp2Up7t_MQ");o.oauth_signature=n;var s={url:e,data:o,cache:!0,dataType:"jsonp",success:function(i){console.log(i);for(var e=0;e<i.businesses.length;e++)model.locations.push({name:i.businesses[e].name,address:i.businesses[e].location.display_address,coordinates:{lat:i.businesses[e].location.coordinate.latitude,lng:i.businesses[e].location.coordinate.longitude},categories:i.businesses[e].categories,phone:i.businesses[e].display_phone,image:i.businesses[e].image_url,id:i.businesses[e].id,rating_img:i.businesses[e].rating_img_url,top_comment:i.businesses[e].snippet_text,url:i.businesses[e].url});console.log(model.locations),viewModel.initialize()},fail:function(){alert("Failed to get Yelp Data")}};$.ajax(s)}},viewModel={visibleLocations:ko.observableArray([]),filter:ko.observable(""),initialize:function(){visibleLocations=viewModel.visibleLocations();for(var i=0;i<model.locations.length;i++)visibleLocations.push(model.locations[i]);viewModel.setMarkers(),viewModel.setWindows(),viewModel.setBounceToClickedMarkers(),ko.applyBindings(viewModel),viewModel.filter.subscribe(viewModel.search)},setMarkers:function(){for(var i=0;i<visibleLocations.length;i++){var e=new google.maps.Marker({position:visibleLocations[i].coordinates,map:map,title:visibleLocations[i].name,name:visibleLocations[i].name,address:visibleLocations[i].address,phone:visibleLocations[i].phone,image:visibleLocations[i].image,comment:visibleLocations[i].top_comment,rating:visibleLocations[i].rating_img,url:visibleLocations[i].url,categories:visibleLocations[i].categories,animation:google.maps.Animation.DROP});visibleLocations[i].marker=e,bounds.extend(e.position)}},setWindows:function(){infoWindow=new google.maps.InfoWindow;for(var i=0;i<visibleLocations.length;i++)visibleLocations[i].marker.addListener("click",function(){viewModel.populateWindow(this,infoWindow)})},populateWindow:function(i,e){e.marker=i,e.setContent("<div><h2>"+i.title+"</h2><p> <strong>Address</strong>: "+i.address[0]+"<br/>"+i.address[2]+"</p></p><strong>More Information</strong>: <a target='#' href='"+i.url+"'>"+i.url+"</a><p><strong>Phone</strong>: "+i.phone+"</p><img src='"+i.image+"'><p><strong>Yelp Rating</strong>: <img src='"+i.rating+"'></p><p><strong>Top Yelp Comment</strong>: \""+i.comment+'"</p></div>'),e.open(map,i),e.addListener("closeclick",function(){e.marker=null,i.setAnimation(null)})},search:function(i){for(var e=0;e<visibleLocations.length;e++)visibleLocations[e].marker.setMap(null);viewModel.visibleLocations.removeAll();for(var o=0;o<model.locations.length;o++)model.locations[o].name.toLowerCase().indexOf(i.toLowerCase())>=0&&viewModel.visibleLocations.push(model.locations[o]);viewModel.setMarkers(),viewModel.setWindows(),viewModel.setBounceToClickedMarkers()},setBounceToClickedMarkers:function(){for(var i=0;i<visibleLocations.length;i++)!function(i){visibleLocations[i].marker.addListener("click",function(){if(console.log(visibleLocations[i].marker),null!==visibleLocations[i].marker.getAnimation())visibleLocations[i].marker.setAnimation(null);else{visibleLocations[i].marker.setAnimation(google.maps.Animation.BOUNCE);for(var e=0;e<visibleLocations.length;e++)visibleLocations[e]!==visibleLocations[i]&&visibleLocations[e].marker.getAnimation()===google.maps.Animation.BOUNCE&&visibleLocations[e].marker.setAnimation(null)}})}(i)},setBounceToClickedListItems:function(i){if(null!==i.getAnimation())i.setAnimation(null);else{i.setAnimation(google.maps.Animation.BOUNCE);for(var e=0;e<visibleLocations.length;e++)visibleLocations[e].marker!==i&&visibleLocations[e].marker.getAnimation()===google.maps.Animation.BOUNCE&&visibleLocations[e].marker.setAnimation(null)}}};