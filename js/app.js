var map,portland,infoWindow,visibleLocations,bounds,listView=document.getElementById("listView"),view={initMap:function(){portland=new google.maps.LatLng(45.522946,-122.673517),map=new google.maps.Map(document.getElementById("map"),{center:portland,zoom:16}),bounds=new google.maps.LatLngBounds,model.initialize()},mapError:function(){alert("Unable to load google map. Please try again")},openList:function(){listView.style.height="40%"},closeList:function(){listView.style.height="0"}},model={locations:[],initialize:function(){function o(){return Math.floor(1e12*Math.random()).toString()}var e="https://api.yelp.com/v2/search",i={oauth_consumer_key:"LyiqmxYUbuLB9p1a_lx8gA",oauth_token:"GZpLwoqEwunNaFT7HwNoRsCiXE3mxMXt",oauth_nonce:o(),oauth_timestamp:Math.floor(Date.now()/1e3),oauth_signature_method:"HMAC-SHA1",oauth_version:"1.0",callback:"cb",term:"restaurant",location:"Portland Chinatown",cll:"45.5231, -122.6765",radius_filter:600,sort:2},n=oauthSignature.generate("GET",e,i,"rjAxpO7SFR9hyQUtOPvEqOgdDa0","FUgWz5YLb7CyIhOOpUp2Up7t_MQ");i.oauth_signature=n;var s={url:e,data:i,cache:!0,dataType:"jsonp",success:function(o){console.log(o);for(var e=0;e<o.businesses.length;e++){var i=o.businesses[e].name||"No name provided",n=o.businesses[e].location.display_address||"No address provided",s={lat:o.businesses[e].location.coordinate.latitude,lng:o.businesses[e].location.coordinate.longitude}||"No coordinates provided",t=o.businesses[e].categories||"No categories provided",a=o.businesses[e].display_phone||"No phone provided",l=o.businesses[e].image_url||"No image provided",r=o.businesses[e].id||"No id provided",c=o.businesses[e].rating_img_url||"No rating image provided",d=o.businesses[e].snippet_text||"No comment provided",m=o.businesses[e].url||"No URL provided";model.locations.push({name:i,address:n,coordinates:s,categories:t,phone:a,image:l,id:r,rating_img:c,top_comment:d,url:m})}console.log(model.locations),viewModel.initialize()},error:function(o){alert("Failed to get Yelp Data because of"+o)}};$.ajax(s)}},viewModel={visibleLocations:ko.observableArray([]),filter:ko.observable(""),initialize:function(){visibleLocations=viewModel.visibleLocations();for(var o=0;o<model.locations.length;o++)visibleLocations.push(model.locations[o]);viewModel.setMarkers(),viewModel.setWindows(),visibleLocations.forEach(function(o){!function(o){o.marker.addListener("click",function(){viewModel.setBounce(o.marker)})}(o)}),ko.applyBindings(viewModel),viewModel.filter.subscribe(viewModel.search)},setMarkers:function(){for(var o=0;o<visibleLocations.length;o++){var e=new google.maps.Marker({position:visibleLocations[o].coordinates,map:map,title:visibleLocations[o].name,name:visibleLocations[o].name,address:visibleLocations[o].address,phone:visibleLocations[o].phone,image:visibleLocations[o].image,comment:visibleLocations[o].top_comment,rating:visibleLocations[o].rating_img,url:visibleLocations[o].url,categories:visibleLocations[o].categories,animation:google.maps.Animation.DROP});visibleLocations[o].marker=e,bounds.extend(e.position)}},setWindows:function(){infoWindow=new google.maps.InfoWindow;for(var o=0;o<visibleLocations.length;o++)visibleLocations[o].marker.addListener("click",function(){viewModel.populateWindow(this,infoWindow)})},populateWindow:function(o,e){e.marker=o,e.setContent("<div><h2>"+o.title+"</h2><p> <strong>Address</strong>: "+o.address[0]+"<br/>"+o.address[2]+"</p></p><strong>More Information</strong>: <a target='#' href='"+o.url+"'>"+o.url+"</a><p><strong>Phone</strong>: "+o.phone+"</p><img src='"+o.image+"'><p><strong>Yelp Rating</strong>: <img src='"+o.rating+"'></p><p><strong>Top Yelp Comment</strong>: \""+o.comment+'"</p></div>'),e.open(map,o),e.addListener("closeclick",function(){e.marker=null,o.setAnimation(null)})},search:function(o){infoWindow.close();for(var e=0;e<visibleLocations.length;e++)visibleLocations[e].marker.setVisible(!1),visibleLocations[e].marker.setAnimation(null);viewModel.visibleLocations.removeAll();for(var i=0;i<model.locations.length;i++)if(model.locations[i].name.toLowerCase().indexOf(o.toLowerCase())>=0){viewModel.visibleLocations.push(model.locations[i]);for(var n=0;n<visibleLocations.length;n++)visibleLocations[n].marker.setVisible(!0)}},setBounce:function(o){if(null!==o.getAnimation())o.setAnimation(null);else{o.setAnimation(google.maps.Animation.BOUNCE);for(var e=0;e<visibleLocations.length;e++)visibleLocations[e].marker!==o&&visibleLocations[e].marker.getAnimation()===google.maps.Animation.BOUNCE&&visibleLocations[e].marker.setAnimation(null)}}};